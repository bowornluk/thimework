<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (Internship System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #video.mirrored, #canvas.mirrored { transform: scaleX(-1); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="config-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-6 rounded shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="url" id="web-app-url" class="w-full border p-2 rounded mb-4" placeholder="‡∏ß‡∏≤‡∏á Google Web App URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            <button onclick="saveConfig()" class="bg-blue-600 text-white w-full py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
            <input type="text" id="admin-user" class="w-full border p-3 rounded mb-4" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="admin-pass" class="w-full border p-3 rounded mb-6" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <div class="flex gap-2">
                <button onclick="closeLogin()" class="flex-1 bg-gray-200 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="doLogin()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div class="flex h-full" id="main-layout">
        
        <aside id="sidebar" class="w-64 bg-slate-800 text-white hidden flex-col transition-all duration-300">
            <div class="p-6 text-center font-bold text-xl border-b border-slate-700">Internship Admin</div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showPage('dashboard')" class="w-full text-left p-3 hover:bg-slate-700 rounded flex items-center gap-2">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                <button onclick="showPage('members')" class="w-full text-left p-3 hover:bg-slate-700 rounded flex items-center gap-2">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                <button onclick="showPage('attendance')" class="w-full text-left p-3 hover:bg-slate-700 rounded flex items-center gap-2">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
                <button onclick="showPage('announce')" class="w-full text-left p-3 hover:bg-slate-700 rounded flex items-center gap-2">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</button>
                <button onclick="showPage('settings')" class="w-full text-left p-3 hover:bg-slate-700 rounded flex items-center gap-2">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏±‡πâ‡∏ô)</button>
                <button onclick="showPage('summary')" class="w-full text-left p-3 hover:bg-slate-700 rounded flex items-center gap-2">üìë ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
            </nav>
            <div class="p-4 border-t border-slate-700">
                <button onclick="logout()" class="w-full bg-red-600 py-2 rounded hover:bg-red-700">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto relative">
            
            <header id="public-header" class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-40">
                <h1 class="text-xl md:text-2xl font-bold text-blue-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h1>
                <div class="flex gap-2">
                    <button onclick="openMyStats()" class="bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    <button onclick="openLogin()" class="bg-slate-700 text-white px-4 py-2 rounded hover:bg-slate-800 text-sm">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
                    <button onclick="resetConfig()" class="text-xs text-gray-400 underline">Reset URL</button>
                </div>
            </header>

            <div id="page-scan" class="p-4 md:p-8 max-w-4xl mx-auto text-center">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-2">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
                    <p class="text-gray-500 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢</p>

                    <div class="relative bg-black rounded-lg overflow-hidden mx-auto w-full max-w-lg aspect-video mb-4 flex items-center justify-center">
                        <video id="video" class="absolute w-full h-full object-cover hidden mirrored" autoplay muted playsinline></video>
                        <canvas id="canvas" class="absolute w-full h-full mirrored"></canvas>
                        <div id="camera-placeholder" class="text-gray-400 flex flex-col items-center">
                            <svg class="w-16 h-16 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>
                        </div>
                    </div>

                    <div class="flex flex-col items-center gap-4">
                        <select id="camera-select" class="border p-2 rounded mb-2 hidden"></select>
                        <button id="toggle-scan-btn" class="bg-blue-600 text-white text-lg px-8 py-3 rounded-full shadow-lg hover:bg-blue-700 transition w-48">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                    </div>

                    <div id="scan-log" class="mt-6 text-left max-h-40 overflow-y-auto bg-gray-100 p-4 rounded text-sm">
                        <p class="text-gray-400 text-center italic">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ...</p>
                    </div>
                </div>
            </div>

            <div id="page-dashboard" class="page-section hidden p-6">
                <h2 class="text-2xl font-bold mb-6">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö (Dashboard)</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                        <div class="text-gray-500 text-sm">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="text-2xl font-bold" id="stat-total-users">-</div>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                        <div class="text-gray-500 text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        <div class="text-2xl font-bold" id="stat-checked-in">-</div>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-500">
                        <div class="text-gray-500 text-sm">‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        <div class="text-2xl font-bold" id="stat-late">-</div>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-red-500">
                        <div class="text-gray-500 text-sm">‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
                        <div class="text-2xl font-bold" id="stat-absent">-</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold mb-4">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                        <canvas id="deptChart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold mb-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="page-members" class="page-section hidden p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                    <button onclick="openMemberModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>
                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="p-3">‡∏£‡∏π‡∏õ</th>
                                <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
                                <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="p-3">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th class="p-3">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                <th class="p-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body"></tbody>
                    </table>
                </div>
            </div>

             <div id="page-attendance" class="page-section hidden p-6">
                <h2 class="text-2xl font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
                <div class="bg-white p-4 rounded shadow mb-4 flex gap-4">
                    <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." id="att-search" class="border p-2 rounded">
                    <select id="att-filter-dept" class="border p-2 rounded"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option></select>
                </div>
                <div class="bg-white rounded shadow overflow-x-auto h-[600px]">
                    <table class="w-full text-left relative">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
                                <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th class="p-3">‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                <th class="p-3">‡∏≠‡∏≠‡∏Å</th>
                                <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-3">‡∏ä‡∏°.‡∏£‡∏ß‡∏°</th>
                                <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="page-summary" class="page-section hidden p-6">
                <h2 class="text-2xl font-bold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
                
                <div class="bg-white p-4 rounded shadow mb-4 flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div class="flex gap-4 w-full md:w-auto">
                        <select id="sum-filter-dept" class="border p-2 rounded w-full md:w-48">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                        </select>
                        <button onclick="loadInternshipSummary()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    </div>

                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 border-b uppercase text-sm text-gray-600">
                            <tr>
                                <th class="p-3">‡∏£‡∏π‡∏õ</th>
                                <th class="p-3">‡∏£‡∏´‡∏±‡∏™</th>
                                <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="p-3">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th class="p-3 text-center">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ß‡∏±‡∏ô)</th>
                                <th class="p-3 text-center text-orange-600">‡∏™‡∏≤‡∏¢ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th>
                                <th class="p-3 text-center text-red-600">‡∏•‡∏≤ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th>
                                <th class="p-3 text-right">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body" class="text-sm">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="page-announce" class="page-section hidden p-6">
                <h2 class="text-2xl font-bold mb-6">‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ (Email)</h2>
                <div class="bg-white p-6 rounded shadow max-w-2xl">
                    <div class="mb-4">
                        <label class="block mb-1 font-bold">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                        <input type="text" id="ann-topic" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-bold">‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                        <select id="ann-target" class="w-full border p-2 rounded">
                            <option value="all">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <textarea id="ann-message" rows="5" class="w-full border p-2 rounded"></textarea>
                    </div>
                    <button onclick="sendAnnouncement()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                </div>
            </div>

            <div id="page-settings" class="page-section hidden p-6">
                <h2 class="text-2xl font-bold mb-6">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold mb-2">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="new-dept-name" class="border p-1 rounded flex-1" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤">
                            <button onclick="addSetting('Department')" class="bg-blue-500 text-white px-3 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <ul id="list-depts" class="space-y-1"></ul>
                    </div>
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</h3>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="new-level-name" class="border p-1 rounded flex-1" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô">
                            <button onclick="addSetting('Level')" class="bg-blue-500 text-white px-3 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <ul id="list-levels" class="space-y-1"></ul>
                    </div>
                </div>
            </div>

        </main>
    </div>


    <div id="member-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4" id="member-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            <form id="member-form">
                <input type="hidden" id="mem-row-index">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block text-sm">‡∏£‡∏´‡∏±‡∏™</label><input type="text" id="mem-id" class="w-full border p-2 rounded" required></div>
                    <div><label class="block text-sm">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="mem-name" class="w-full border p-2 rounded" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="mem-dept" class="w-full border p-2 rounded"></select>
                    </div>
                    <div>
                        <label class="block text-sm">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                        <select id="mem-level" class="w-full border p-2 rounded"></select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="mem-email" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-sm">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á)</label>
                    <input type="file" id="mem-img" accept="image/*" class="w-full text-sm">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="document.getElementById('member-modal').classList.add('hidden')" class="bg-gray-300 px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-[100] hidden">
        <div class="loader w-12 h-12 rounded-full border-4 border-gray-200"></div>
        <p class="mt-2 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</p>
    </div>

<script>
    // --- CONFIG & STATE ---
    let WEB_APP_URL = localStorage.getItem('webapp_url') || '';
    const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
    let faceMatcher = null;
    let studentsData = []; // For Face API
    let membersCache = []; // For Admin Table (Fixes HTML injection bug)
    let isCameraActive = false;
    let checkInInterval = null;
    let isAdmin = false;
    
    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        if(!WEB_APP_URL) document.getElementById('config-modal').classList.remove('hidden');
        else await loadModels();
    });

    const saveConfig = () => {
        const url = document.getElementById('web-app-url').value;
        if(url) { localStorage.setItem('webapp_url', url); location.reload(); }
    };
    const resetConfig = () => { localStorage.removeItem('webapp_url'); location.reload(); };
    const showLoading = (show) => document.getElementById('loading').classList.toggle('hidden', !show);

    // --- FACE API & SCANNING ---
    async function loadModels() {
        showLoading(true);
        try {
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            await loadStudentsForFace();
        } catch (e) { console.error("Model Error:", e); }
        showLoading(false);
    }

    async function loadStudentsForFace() {
        const res = await callAPI('getUsers');
        if(res && Array.isArray(res)) {
            studentsData = res.map(row => ({
                id: row[0], name: row[1], level: row[2], dept: row[3], email: row[4],
                faceEncoding: row[5], img: row[6]
            }));
            const labeledDescriptors = studentsData
                .filter(s => s.faceEncoding)
                .map(s => {
                    try {
                        return new faceapi.LabeledFaceDescriptors(String(s.id), [new Float32Array(JSON.parse(s.faceEncoding))]);
                    } catch(e) { return null; }
                })
                .filter(d => d !== null);
                
            if(labeledDescriptors.length > 0) faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.45);
        }
    }

    document.getElementById('toggle-scan-btn').addEventListener('click', toggleScan);

    async function toggleScan() {
        const btn = document.getElementById('toggle-scan-btn');
        const video = document.getElementById('video');
        const ph = document.getElementById('camera-placeholder');

        if(!isCameraActive) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.classList.remove('hidden');
                ph.classList.add('hidden');
                btn.innerText = '‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô';
                btn.classList.replace('bg-blue-600','bg-red-600');
                isCameraActive = true;
                startFaceDetection();
            } catch(e) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error'); }
        } else {
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            video.classList.add('hidden');
            ph.classList.remove('hidden');
            btn.innerText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô';
            btn.classList.replace('bg-red-600','bg-blue-600');
            isCameraActive = false;
            if(checkInInterval) clearInterval(checkInInterval);
            document.getElementById('canvas').getContext('2d').clearRect(0,0,1000,1000);
        }
    }

    function startFaceDetection() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        
        checkInInterval = setInterval(async () => {
            if(!isCameraActive || !faceMatcher) return;
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
            
            try {
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resized = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                if(resized.length > 0) {
                    const result = faceMatcher.findBestMatch(resized[0].descriptor);
                    const box = resized[0].detection.box;
                    
                    if(result.label !== 'unknown') {
                        const student = studentsData.find(s => String(s.id) === result.label);
                        if(student) {
                            new faceapi.draw.DrawBox(box, { label: student.name }).draw(canvas);
                            if(!student.lastScan || (Date.now() - student.lastScan > 60000)) { 
                                student.lastScan = Date.now();
                                processCheckIn(student);
                            }
                        }
                    } else {
                         new faceapi.draw.DrawBox(box, { label: '‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å' }).draw(canvas);
                    }
                }
            } catch(e) { console.log(e); }
        }, 500);
    }

    async function processCheckIn(student) {
        let lat = '', lng = '';
        if(navigator.geolocation) {
            try {
                const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout: 5000}));
                lat = pos.coords.latitude; lng = pos.coords.longitude;
            } catch(e) { console.log('GPS Fail'); }
        }

        const res = await callAPI('recordAttendance', { 
            id: student.id, name: student.name, lat, lng 
        });

        if(res) {
            Swal.fire({
                title: res.type === 'CheckIn' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : (res.type === 'CheckOut' ? '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'),
                text: res.message,
                icon: res.type === 'AlreadyCheckedOut' ? 'warning' : 'success',
                timer: 3000, showConfirmButton: false
            });
            const log = document.getElementById('scan-log');
            log.innerHTML = `<div class="p-2 border-b text-xs">${new Date().toLocaleTimeString()} - ${res.message}</div>` + log.innerHTML;
        }
    }

    // --- API HELPER ---
    async function callAPI(action, payload = {}) {
        try {
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action, payload })
            });
            const json = await res.json();
            if(json.status === 'error') throw new Error(json.message);
            return json.data;
        } catch(e) {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', e.message, 'error');
            return null;
        }
    }

    // --- LOGIN & ADMIN UI ---
    function openLogin() { document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }
    async function doLogin() {
        const u = document.getElementById('admin-user').value;
        const p = document.getElementById('admin-pass').value;
        showLoading(true);
        const res = await callAPI('login', { username: u, password: p });
        showLoading(false);
        if(res) {
            isAdmin = true;
            closeLogin();
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('flex');
            document.getElementById('public-header').classList.add('hidden');
            document.getElementById('page-scan').classList.add('hidden');
            showPage('dashboard');
            loadAdminData();
        }
    }
    function logout() { location.reload(); }

    function showPage(pageName) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
        document.getElementById('page-' + pageName).classList.remove('hidden');
    }

    async function loadAdminData() {
        const depts = await callAPI('getDepartments');
        const levels = await callAPI('getLevels');
        if(depts && levels) updateSelects(depts, levels);
        
        if(!document.getElementById('page-dashboard').classList.contains('hidden')) loadDashboard();
        if(!document.getElementById('page-members').classList.contains('hidden')) loadMembersTable();
        if(!document.getElementById('page-attendance').classList.contains('hidden')) loadAttendanceTable();
        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ---
        if(!document.getElementById('page-summary').classList.contains('hidden')) loadInternshipSummary();
        // -----------------------
    }

    function updateSelects(depts, levels) {
        const deptOpts = depts.map(d => `<option>${d[0]}</option>`).join('');
        const levelOpts = levels.map(l => `<option>${l[0]}</option>`).join('');
        
        document.getElementById('mem-dept').innerHTML = deptOpts;
        document.getElementById('mem-level').innerHTML = levelOpts;
        document.getElementById('att-filter-dept').innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>' + deptOpts;
        document.getElementById('ann-target').innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + deptOpts;
        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ---
        document.getElementById('sum-filter-dept').innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>' + deptOpts; 
        // -----------------------

        document.getElementById('list-depts').innerHTML = depts.map((d, i) => `<li class="flex justify-between bg-gray-50 p-2">${d[0]} <button onclick="delSetting('deleteDepartment', ${i+2})" class="text-red-500">‡∏•‡∏ö</button></li>`).join('');
        document.getElementById('list-levels').innerHTML = levels.map((l, i) => `<li class="flex justify-between bg-gray-50 p-2">${l[0]} <button onclick="delSetting('deleteLevel', ${i+2})" class="text-red-500">‡∏•‡∏ö</button></li>`).join('');
    }

    // --- DASHBOARD ---
    let chartInstance1, chartInstance2;
    async function loadDashboard() {
        const stats = await callAPI('getDashboardData');
        if(!stats) return;

        document.getElementById('stat-total-users').innerText = stats.totalUsers;
        document.getElementById('stat-checked-in').innerText = stats.checkedInToday;
        document.getElementById('stat-late').innerText = stats.lateToday;
        document.getElementById('stat-absent').innerText = stats.absentToday;

        const ctx1 = document.getElementById('deptChart').getContext('2d');
        if(chartInstance1) chartInstance1.destroy();
        chartInstance1 = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: Object.keys(stats.deptCounts),
                datasets: [{ data: Object.values(stats.deptCounts), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
            }
        });

        const ctx2 = document.getElementById('dailyChart').getContext('2d');
        if(chartInstance2) chartInstance2.destroy();
        chartInstance2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏™‡∏≤‡∏¢', '‡∏•‡∏≤'],
                datasets: [{ 
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô',
                    data: [stats.dailyStatus.onTime, stats.dailyStatus.late, stats.dailyStatus.leave], 
                    backgroundColor: ['#10b981', '#f59e0b', '#6366f1'] 
                }]
            }
        });
    }

    // --- MEMBER MANAGEMENT (FIXED) ---
    async function loadMembersTable() {
        const data = await callAPI('getUsers');
        const tbody = document.getElementById('members-table-body');
        tbody.innerHTML = '';
        
        if(!data || !Array.isArray(data)) {
             tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</td></tr>';
             return;
        }

        membersCache = data; // Cache data to avoid HTML injection issues

        data.forEach((row, i) => {
            tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><img src="${row[6] || 'https://placehold.co/50'}" class="w-10 h-10 rounded-full object-cover"></td>
                    <td class="p-3">${row[0]}</td>
                    <td class="p-3">${row[1]}</td>
                    <td class="p-3">${row[3]}</td>
                    <td class="p-3 text-xs text-gray-500">${row[4] || '-'}</td>
                    <td class="p-3">
                        <button onclick="prepareEditMember(${i})" class="text-blue-600 text-sm mr-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteMember(${i+2})" class="text-red-600 text-sm">‡∏•‡∏ö</button>
                    </td>
                </tr>`;
        });
    }

    window.prepareEditMember = (index) => {
        const data = membersCache[index];
        const rowIndex = index + 2;
        
        document.getElementById('mem-row-index').value = rowIndex;
        document.getElementById('mem-id').value = data[0];
        document.getElementById('mem-name').value = data[1];
        document.getElementById('mem-level').value = data[2];
        document.getElementById('mem-dept').value = data[3];
        document.getElementById('mem-email').value = data[4];
        document.getElementById('member-modal-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        document.getElementById('member-modal').classList.remove('hidden');
    }

    function openMemberModal() {
        document.getElementById('member-form').reset();
        document.getElementById('mem-row-index').value = '';
        document.getElementById('member-modal-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        document.getElementById('member-modal').classList.remove('hidden');
    }

    document.getElementById('member-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const file = document.getElementById('mem-img').files[0];
        let encoding = null, imgBase64 = null;

        if(file) {
            try {
                const img = await faceapi.bufferToImage(file);
                const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                if(!detection) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ');
                encoding = JSON.stringify(Array.from(detection.descriptor));
                
                const cvs = document.createElement('canvas');
                cvs.width = 150; cvs.height = 150 * (img.height/img.width);
                cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                imgBase64 = cvs.toDataURL('image/jpeg', 0.8);
            } catch(err) {
                showLoading(false);
                return Swal.fire('Error', err.message, 'error');
            }
        }

        const payload = {
            rowIndex: document.getElementById('mem-row-index').value,
            id: document.getElementById('mem-id').value,
            name: document.getElementById('mem-name').value,
            dept: document.getElementById('mem-dept').value,
            level: document.getElementById('mem-level').value,
            email: document.getElementById('mem-email').value,
            faceEncoding: encoding,
            imageData: imgBase64
        };

        const action = payload.rowIndex ? 'updateUser' : 'addUser';
        await callAPI(action, payload);
        document.getElementById('member-modal').classList.add('hidden');
        await loadMembersTable();
        await loadStudentsForFace(); 
        showLoading(false);
        Swal.fire('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    });

    window.deleteMember = async (index) => {
        if(await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', showCancelButton: true }).then(r => r.isConfirmed)) {
            showLoading(true);
            await callAPI('deleteUser', { rowIndex: index });
            await loadMembersTable();
            showLoading(false);
        }
    };

    // --- ATTENDANCE TABLE ---
    async function loadAttendanceTable() {
        const data = await callAPI('getAttendance');
        const tbody = document.getElementById('attendance-table-body');
        
        if (!data || !Array.isArray(data)) {
             tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
             return;
        }

        tbody.innerHTML = data.map(r => `
            <tr class="border-b text-sm hover:bg-gray-50">
                <td class="p-2">${new Date(r[2]).toLocaleDateString('th-TH')}</td>
                <td class="p-2">${r[0]}</td>
                <td class="p-2">${r[1]}</td>
                <td class="p-2 text-green-600 font-bold">${r[3] ? String(r[3]).substring(0,5) : '-'}</td>
                <td class="p-2 text-red-600 font-bold">${r[4] ? String(r[4]).substring(0,5) : '-'}</td>
                <td class="p-2">
                    <span class="px-2 py-1 rounded text-xs text-white ${r[5]==='‡∏™‡∏≤‡∏¢'?'bg-orange-500':'bg-green-500'}">
                        ${r[5]}
                    </span>
                </td>
                <td class="p-2 font-bold">${r[6] || '-'}</td>
                <td class="p-2 text-xs text-gray-600 truncate max-w-[200px]" title="${r[7]}">
                    ${r[7] || '-'}
                </td>
            </tr>
        `).join('');
    }

    // --- ANNOUNCEMENTS ---
    async function sendAnnouncement() {
        const payload = {
            topic: document.getElementById('ann-topic').value,
            target: document.getElementById('ann-target').value,
            message: document.getElementById('ann-message').value
        };
        showLoading(true);
        const res = await callAPI('sendAnnouncement', payload);
        showLoading(false);
        Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', res, 'success');
    }

    // --- SETTINGS ---
    async function addSetting(type) {
        const val = document.getElementById(type === 'Department' ? 'new-dept-name' : 'new-level-name').value;
        if(!val) return;
        showLoading(true);
        await callAPI('add' + type, { name: val });
        await loadAdminData(); 
        document.getElementById(type === 'Department' ? 'new-dept-name' : 'new-level-name').value = '';
        showLoading(false);
    }
    window.delSetting = async (action, index) => {
        if(await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', showCancelButton: true }).then(r => r.isConfirmed)) {
            showLoading(true);
            await callAPI(action, { rowIndex: index });
            await loadAdminData();
            showLoading(false);
        }
    };

    // --- STUDENT CHECK STATS ---
    window.openMyStats = async () => {
        const { value: sid } = await Swal.fire({ title: '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', input: 'text', showCancelButton: true });
        if(sid) {
            showLoading(true);
            const res = await callAPI('getStudentSummary', { studentId: sid });
            showLoading(false);
            if(res) {
                Swal.fire({
                    title: `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${sid}`,
                    html: `
                        <div class="text-left">
                            <p><b>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°:</b> ${res.totalHours} ‡∏ä‡∏°.</p>
                            <p><b>‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥:</b> ${res.counts.onTime} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                            <p><b>‡∏™‡∏≤‡∏¢:</b> ${res.counts.late} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        </div>
                    `
                });
            } else {
                 Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }
    };
    // --- INTERNSHIP SUMMARY LOGIC ---
    let summaryDataCache = [];

    async function loadInternshipSummary() {
        showLoading(true);
        const data = await callAPI('getInternshipStats');
        showLoading(false);

        if (data) {
            summaryDataCache = data;
            renderSummaryTable();
        }
    }

    function renderSummaryTable() {
        const filterDept = document.getElementById('sum-filter-dept').value;
        const tbody = document.getElementById('summary-table-body');
        tbody.innerHTML = '';

        const filteredData = summaryDataCache.filter(item => {
            return filterDept === "" || item.dept === filterDept;
        });

        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            return;
        }

        filteredData.forEach(row => {
            tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><img src="${row.img || 'https://placehold.co/40'}" class="w-10 h-10 rounded-full object-cover border"></td>
                    <td class="p-3 font-mono">${row.id}</td>
                    <td class="p-3 font-medium">${row.name}</td>
                    <td class="p-3 text-gray-500">${row.dept}</td>
                    <td class="p-3 text-center font-bold">${row.totalDays}</td>
                    <td class="p-3 text-center text-orange-600 font-bold">${row.late}</td>
                    <td class="p-3 text-center text-red-600 font-bold">${row.leave}</td>
                    <td class="p-3 text-right font-bold text-blue-700">${row.hours} ‡∏ä‡∏°.</td>
                </tr>
            `;
        });
    }

    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
    document.getElementById('sum-filter-dept').addEventListener('change', renderSummaryTable);
</script>
</body>
</html>
