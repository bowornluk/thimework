<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบลงเวลาฝึกงาน AI</title>
  
  <!-- CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Link for FontAwesome (Correct Way) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- *** CRITICAL: Use the exact version from scan2.txt *** -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .sidebar-active { background-color: #1e3a8a; border-left: 4px solid #60a5fa; }
    
    /* Loader */
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Video & Canvas */
    #video-container { position: relative; border-radius: 1rem; overflow: hidden; background: #000; }
    #video { width: 100%; height: 100%; object-fit: cover; } 
    #overlay { position: absolute; top: 0; left: 0; pointer-events: none; }
    
    /* Scan Line Animation */
    .scan-line {
      position: absolute; width: 100%; height: 4px; background: #00ff00;
      box-shadow: 0 0 10px #00ff00; animation: scan 2s infinite linear; display: none;
    }
    @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-xl transition-all duration-300">
      <div class="p-6 flex items-center gap-3 border-b border-slate-700">
        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold text-xl">
          <i class="fa-solid fa-school"></i>
        </div>
        <div>
          <h1 class="font-bold text-lg">ระบบฝึกงาน</h1>
          <p class="text-xs text-slate-400">AI Attendance</p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2">
        <a href="#" onclick="showPage('home')" id="nav-home" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition sidebar-active">
          <i class="fa-solid fa-camera"></i> ลงเวลาเข้างาน
        </a>
        <a href="#" onclick="showPage('stats-student')" id="nav-stats-student" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition">
          <i class="fa-solid fa-chart-bar"></i> สถิติของฉัน
        </a>

        <!-- Admin Menus (Hidden) -->
        <div id="admin-menu-group" class="hidden">
            <div class="pt-4 pb-2 text-xs text-slate-500 uppercase font-semibold">ผู้ดูแลระบบ</div>
            <a href="#" onclick="showPage('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition">
              <i class="fa-solid fa-chart-pie"></i> แดชบอร์ดภาพรวม
            </a>
            <a href="#" onclick="showPage('users')" id="nav-users" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition">
              <i class="fa-solid fa-users"></i> ข้อมูลนักเรียน
            </a>
            <a href="#" onclick="showPage('history')" id="nav-history" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition">
              <i class="fa-solid fa-clock-rotate-left"></i> ประวัติลงเวลา
            </a>
            <a href="#" onclick="showPage('notify')" id="nav-notify" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition">
              <i class="fa-solid fa-bullhorn"></i> แจ้งประกาศ
            </a>
            <a href="#" onclick="showPage('settings')" id="nav-settings" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition">
              <i class="fa-solid fa-cog"></i> ตั้งค่าระบบ
            </a>
        </div>
      </nav>

      <div class="p-4 border-t border-slate-700">
        <button id="btn-login" onclick="adminLogin()" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:text-white">
          <i class="fa-solid fa-lock"></i> เข้าสู่ระบบ Admin
        </button>
        <button id="btn-logout" onclick="adminLogout()" class="hidden w-full text-left px-4 py-2 text-sm text-red-400 hover:text-red-300">
          <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-y-auto relative">
      <!-- Mobile Header -->
      <header class="bg-slate-900 text-white p-4 flex md:hidden justify-between items-center shadow-md">
        <div class="flex items-center gap-2"><i class="fa-solid fa-school"></i> <span>ระบบฝึกงาน AI</span></div>
        <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"><i class="fa-solid fa-bars"></i></button>
      </header>
      
      <!-- Mobile Menu -->
      <div id="mobile-menu" class="hidden md:hidden bg-slate-800 text-white p-4 space-y-2">
         <a onclick="showPage('home')" class="block py-2">ลงเวลา</a>
         <a onclick="adminLogin()" class="block py-2">เข้าสู่ระบบ Admin</a>
      </div>

      <div class="p-4 md:p-8 w-full max-w-6xl mx-auto">
        
        <!-- Global Loading (Visible Initially) -->
        <div id="loading" class="fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-[60]">
           <div class="loader mb-4"></div>
           <p id="loading-text" class="text-white">กำลังเริ่มต้นระบบ...</p>
        </div>

        <!-- 1. HOME: AI SCANNER -->
        <div id="page-home" class="page-section">
           <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 text-center max-w-3xl mx-auto border-t-8 border-blue-600">
              <h2 class="text-2xl font-bold text-slate-800 mb-2">ลงเวลาด้วยใบหน้า</h2>
              <p id="ai-status" class="text-slate-500 mb-6">กำลังเตรียมระบบ AI...</p>
              
              <div id="video-container" class="aspect-video w-full max-w-lg mx-auto bg-black rounded-xl overflow-hidden shadow-inner relative">
                  <video id="video" autoplay muted playsinline></video>
                  <canvas id="overlay"></canvas>
                  <div class="scan-line" id="scan-line"></div>
                  <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-slate-900">
                      <i class="fa-solid fa-camera fa-3x mb-4"></i>
                      <p>กดปุ่ม "เริ่มสแกน" เพื่อเปิดกล้อง</p>
                  </div>
              </div>

              <div class="mt-6 flex justify-center gap-4">
                  <button id="btn-start-camera" onclick="startAiScanning()" class="px-8 py-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition flex items-center gap-2 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                      <i class="fa-solid fa-play"></i> เริ่มสแกน
                  </button>
                  <button id="btn-stop-camera" onclick="stopAiScanning()" class="hidden px-8 py-3 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition flex items-center gap-2">
                      <i class="fa-solid fa-stop"></i> หยุด
                  </button>
              </div>
              
              <!-- Info Box -->
              <div id="last-checkin-info" class="mt-6 hidden p-4 bg-green-50 text-green-800 rounded-lg border border-green-200">
                  <i class="fa-solid fa-check-circle text-2xl mb-1"></i>
                  <h3 class="font-bold text-lg">ลงเวลาสำเร็จ!</h3>
                  <p id="checkin-detail">กำลังบันทึก...</p>
              </div>
           </div>
        </div>

        <!-- 2. STUDENT STATS -->
        <div id="page-stats-student" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-4">สถิติการเข้างานวันนี้</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
                    <p class="text-sm text-gray-500">มาเรียน</p>
                    <h3 id="st-present" class="text-2xl font-bold">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-red-500">
                    <p class="text-sm text-gray-500">ขาด/ลา</p>
                    <h3 id="st-absent" class="text-2xl font-bold">0</h3>
                </div>
            </div>
        </div>

        <!-- 3. ADMIN DASHBOARD -->
        <div id="page-dashboard" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6 text-blue-800">แดชบอร์ดผู้ดูแลระบบ</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <p class="text-slate-500 text-xs">นักเรียนทั้งหมด</p>
                    <h3 id="adm-total" class="text-2xl font-bold text-slate-800">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <p class="text-slate-500 text-xs">มาวันนี้</p>
                    <h3 id="adm-present" class="text-2xl font-bold text-green-600">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <p class="text-slate-500 text-xs">มาสาย</p>
                    <h3 id="adm-late" class="text-2xl font-bold text-yellow-600">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <p class="text-slate-500 text-xs">ขาด</p>
                    <h3 id="adm-absent" class="text-2xl font-bold text-red-600">0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm max-w-2xl mx-auto">
                <h4 class="font-bold mb-4">สรุปการเข้างานวันนี้</h4>
                <canvas id="adminChart"></canvas>
            </div>
        </div>

        <!-- 4. ADMIN USERS -->
        <div id="page-users" class="page-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">จัดการข้อมูลนักเรียน</h2>
                <button onclick="openAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fa-solid fa-plus"></i> เพิ่ม
                </button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr>
                            <th class="p-4">รูป</th>
                            <th class="p-4">ID</th>
                            <th class="p-4">ชื่อ</th>
                            <th class="p-4">สาขา</th>
                            <th class="p-4 text-center">ลบ</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <!-- 5. ADMIN NOTIFY -->
        <div id="page-notify" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">แจ้งประกาศ (Email)</h2>
            <div class="bg-white p-6 rounded-xl shadow max-w-2xl">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">ส่งถึงสาขา</label>
                        <select id="notify-branch" class="w-full p-2 border rounded-lg">
                            <option value="all">ทั้งหมด</option>
                        </select>
                    </div>
                    <input type="text" id="notify-subject" placeholder="หัวข้อประกาศ" class="w-full p-2 border rounded">
                    <textarea id="notify-msg" rows="4" placeholder="รายละเอียด..." class="w-full p-2 border rounded"></textarea>
                    <button onclick="sendNotify()" class="bg-green-600 text-white w-full py-2 rounded hover:bg-green-700">ส่งประกาศ</button>
                </div>
            </div>
        </div>
        
        <!-- 6. ADMIN HISTORY -->
        <div id="page-history" class="page-section hidden">
             <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold">ประวัติการลงเวลาล่าสุด</h2>
                 <div>
                     <select id="history-branch-filter" class="p-2 border rounded-lg text-sm" onchange="loadHistory()">
                         <option value="all">ทุกสาขา</option>
                     </select>
                     <button onclick="loadHistory()" class="ml-2 bg-blue-100 text-blue-800 px-3 py-2 rounded hover:bg-blue-200">
                         <i class="fa-solid fa-rotate"></i>
                     </button>
                 </div>
             </div>
             <div class="bg-white rounded-xl shadow overflow-x-auto">
                 <table class="w-full text-sm text-left">
                     <thead class="bg-slate-50"><tr><th class="p-3">เวลา</th><th class="p-3">ชื่อ</th><th class="p-3">สาขา</th><th class="p-3">สถานะ</th><th class="p-3">หลักฐาน</th></tr></thead>
                     <tbody id="history-table-body"></tbody>
                 </table>
             </div>
        </div>

      </div>
    </main>
  </div>

  <!-- ADD USER MODAL -->
  <div id="modal-add-user" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-xl w-full max-w-md">
          <h3 class="font-bold text-lg mb-4">เพิ่มนักเรียนใหม่</h3>
          <form id="form-add" class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                 <input name="StudentID" placeholder="รหัส" class="w-full border p-2 rounded" required>
                 <select name="Branch" id="modal-branch-select" class="w-full border p-2 rounded" required></select>
              </div>
              <input name="Name" placeholder="ชื่อ-สกุล" class="w-full border p-2 rounded" required>
              <input type="email" name="Email" placeholder="อีเมล" class="w-full border p-2 rounded">
              
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50" onclick="document.getElementById('file-upload').click()">
                  <i class="fa-solid fa-image text-gray-400 text-2xl mb-2"></i>
                  <p class="text-sm text-gray-500" id="file-name">คลิกเพื่อเลือกรูปภาพ (สำหรับ AI)</p>
                  <input type="file" id="file-upload" accept="image/*" class="hidden">
                  <input type="hidden" name="PhotoBase64" id="photo-base64">
              </div>

              <div class="flex justify-end gap-2 mt-4">
                  <button type="button" onclick="document.getElementById('modal-add-user').classList.add('hidden')" class="px-4 py-2 bg-slate-200 rounded">ยกเลิก</button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">บันทึก</button>
              </div>
          </form>
      </div>
  </div>

  <script>
    // --- VARIABLES ---
    let isAdmin = false;
    let studentsData = [];
    let branchData = [];
    let faceMatcher = null;
    let stream = null;
    let isProcessing = false;

    // --- INITIALIZE ---
    window.onload = async () => {
        showLoading(true, "กำลังโหลดข้อมูล...");
        google.script.run.withSuccessHandler(initSystem).getInitialData();
        
        // Start loading Face API immediately
        await loadFaceModels();
    };

    async function loadFaceModels() {
        // [FIXED] Use model URL compatible with scan2.txt logic
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
        document.getElementById('ai-status').innerText = "กำลังโหลดโมเดล AI...";
        
        try {
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            document.getElementById('ai-status').innerText = "AI พร้อมใช้งาน! กด 'เริ่มสแกน'";
            document.getElementById('btn-start-camera').disabled = false;
        } catch (e) {
            console.error("AI Error:", e);
            document.getElementById('ai-status').innerText = "ไม่สามารถโหลด AI ได้ (ลองรีเฟรช)";
        }
    }

    function initSystem(data) {
        studentsData = data.students;
        branchData = data.branches;
        updateDashboard(data.students, []); 
        updateUserTable();
        populateBranchSelects();
        showLoading(false); // Hide loading after data is ready
    }
    
    function updateDashboard(students, logs) {
        const elPresent = document.getElementById('st-present');
        if(elPresent) elPresent.innerText = logs ? logs.length : 0;
    }

    function populateBranchSelects() {
        const selects = ['modal-branch-select', 'notify-branch', 'history-branch-filter'];
        selects.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            if(el.options.length > 0 && el.options[0].value === 'all') el.innerHTML = '<option value="all">ทั้งหมด</option>';
            else el.innerHTML = '';
            
            branchData.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.BranchName;
                opt.innerText = b.BranchName;
                el.appendChild(opt);
            });
        });
    }

    // --- FACE RECOGNITION LOGIC ---
    async function startAiScanning() {
        if (!faceMatcher && studentsData.length > 0) {
            showLoading(true, "กำลังประมวลผลใบหน้า...");
            
            const labeledDescriptors = await Promise.all(
                studentsData.map(async student => {
                    if (!student.PhotoUrl) return null;
                    try {
                        // Use fetchImage from face-api to handle CORS if possible
                        const img = await faceapi.fetchImage(student.PhotoUrl);
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (!detections) return null;
                        return new faceapi.LabeledFaceDescriptors(student.StudentID, [detections.descriptor]);
                    } catch(e) { return null; }
                })
            );
            const valid = labeledDescriptors.filter(d => d != null);
            if (valid.length > 0) faceMatcher = new faceapi.FaceMatcher(valid, 0.6);
            else { 
                alert("ไม่พบข้อมูลใบหน้าในระบบ"); 
                showLoading(false);
                return;
            }
            showLoading(false);
        }

        const video = document.getElementById('video');
        document.getElementById('camera-placeholder').classList.add('hidden');
        document.getElementById('scan-line').style.display = 'block';
        document.getElementById('btn-start-camera').classList.add('hidden');
        document.getElementById('btn-stop-camera').classList.remove('hidden');

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.addEventListener('play', () => {
                const canvas = document.getElementById('overlay');
                const displaySize = { width: video.videoWidth || 640, height: video.videoHeight || 480 };
                faceapi.matchDimensions(canvas, displaySize);

                const interval = setInterval(async () => {
                    if (!stream || isProcessing) return;
                    
                    const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    if (faceMatcher && resizedDetections.length > 0) {
                        const bestMatch = faceMatcher.findBestMatch(resizedDetections[0].descriptor);
                        const box = resizedDetections[0].detection.box;
                        // Draw (Mirror if CSS scales X -1)
                        // If CSS is scaleX(-1), drawing on canvas normally will look flipped relative to video
                        // But since we want simple detection box, standard draw is okay.
                        new faceapi.draw.DrawBox(box, { label: bestMatch.toString() }).draw(canvas);

                        if (bestMatch.label !== 'unknown') {
                            isProcessing = true;
                            clearInterval(interval);
                            handleMatchFound(bestMatch.label, video);
                        }
                    }
                }, 500);
            });
        } catch (err) { Swal.fire("Camera Error", "ไม่สามารถเปิดกล้องได้", "error"); }
    }

    function stopAiScanning() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = null;
        document.getElementById('camera-placeholder').classList.remove('hidden');
        document.getElementById('scan-line').style.display = 'none';
        document.getElementById('btn-start-camera').classList.remove('hidden');
        document.getElementById('btn-stop-camera').classList.add('hidden');
        isProcessing = false;
        const canvas = document.getElementById('overlay');
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    }

    async function handleMatchFound(studentId, videoEl) {
        const canvas = document.createElement('canvas');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoEl, 0, 0);
        const imageBase64 = canvas.toDataURL('image/jpeg');

        stopAiScanning();
        showLoading(true, "พบใบหน้า! กำลังบันทึกข้อมูล...");

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                sendCheckIn(studentId, pos.coords.latitude, pos.coords.longitude, imageBase64);
            }, () => sendCheckIn(studentId, 0, 0, imageBase64));
        } else {
            sendCheckIn(studentId, 0, 0, imageBase64);
        }
    }

    function sendCheckIn(id, lat, lng, img) {
        google.script.run.withSuccessHandler(res => {
            showLoading(false);
            if (res.success) {
                document.getElementById('last-checkin-info').classList.remove('hidden');
                document.getElementById('checkin-detail').innerText = `${res.message} เวลา: ${res.time}`;
                Swal.fire({ icon: 'success', title: 'ลงเวลาสำเร็จ', text: res.message, timer: 3000 });
                // Update simple stat
                const el = document.getElementById('st-present');
                if(el) el.innerText = parseInt(el.innerText) + 1;
            } else {
                Swal.fire('Error', res.message, 'error');
            }
            setTimeout(() => { isProcessing = false; document.getElementById('last-checkin-info').classList.add('hidden'); }, 5000);
        }).processCheckIn({ studentId: id, lat: lat, lng: lng, image: img });
    }

    // --- UI HELPERS ---
    function showPage(id) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('sidebar-active', 'bg-slate-800'));
        
        document.getElementById('page-' + id).classList.remove('hidden');
        const nav = document.getElementById('nav-' + id);
        if(nav) nav.classList.add('sidebar-active');
        
        if(id === 'dashboard' && isAdmin) loadDashboard();
        if(id === 'history' && isAdmin) loadHistory();
    }

    function showLoading(show, text="Loading...") {
        const el = document.getElementById('loading');
        if(show) {
            el.classList.remove('hidden');
            el.style.display = 'flex';
            document.getElementById('loading-text').innerText = text;
        } else {
            el.classList.add('hidden');
            el.style.display = 'none';
        }
    }

    // --- ADMIN ---
    function adminLogin() {
        Swal.fire({
            title: 'Admin Login',
            html: '<input id="swal-u" class="swal2-input" placeholder="User"><input id="swal-p" type="password" class="swal2-input" placeholder="Pass">',
            preConfirm: () => [document.getElementById('swal-u').value, document.getElementById('swal-p').value]
        }).then(res => {
            if(res.isConfirmed && res.value[0] === 'admin' && res.value[1] === '1234') {
                isAdmin = true;
                document.getElementById('admin-menu-group').classList.remove('hidden');
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('btn-logout').classList.remove('hidden');
                Swal.fire('Success', 'ยินดีต้อนรับผู้ดูแลระบบ', 'success');
                showPage('dashboard');
            } else if(res.isConfirmed) {
                Swal.fire('Error', 'รหัสผ่านผิด', 'error');
            }
        });
    }

    function adminLogout() {
        isAdmin = false;
        document.getElementById('admin-menu-group').classList.add('hidden');
        document.getElementById('btn-login').classList.remove('hidden');
        document.getElementById('btn-logout').classList.add('hidden');
        showPage('home');
    }

    function loadDashboard() {
        google.script.run.withSuccessHandler(res => {
            document.getElementById('adm-total').innerText = res.totalStudents;
            document.getElementById('adm-present').innerText = res.todayCheckIn;
            document.getElementById('adm-late').innerText = res.todayLate;
            document.getElementById('adm-absent').innerText = res.todayAbsent;
            renderAdminChart(res.todayCheckIn, res.todayLate, res.todayAbsent);
        }).getDashboardStats();
    }

    function renderAdminChart(present, late, absent) {
        const ctx = document.getElementById('adminChart').getContext('2d');
        if(window.myAdminChart) window.myAdminChart.destroy();
        window.myAdminChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['มาปกติ', 'มาสาย', 'ขาด'],
                datasets: [{ data: [present-late, late, absent], backgroundColor: ['#22c55e', '#eab308', '#ef4444'] }]
            }
        });
    }

    // Users & History
    function updateUserTable() {
        const tbody = document.getElementById('user-table-body');
        if(!tbody) return;
        tbody.innerHTML = '';
        studentsData.forEach(s => {
            tbody.innerHTML += `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-4"><img src="${s.PhotoUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover"></td>
                <td class="p-4">${s.StudentID}</td>
                <td class="p-4">${s.Name}</td>
                <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${s.Branch}</span></td>
                <td class="p-4 text-center"><button onclick="deleteUser('${s.StudentID}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        });
    }

    function openAddUserModal() {
        document.getElementById('form-add').reset();
        document.getElementById('file-name').innerText = "คลิกเพื่อเลือกรูปภาพ (สำหรับ AI)";
        document.getElementById('photo-base64').value = "";
        document.getElementById('modal-add-user').classList.remove('hidden');
    }

    // --- EVENT LISTENERS ---
    document.getElementById('file-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            document.getElementById('file-name').innerText = file.name;
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('photo-base64').value = e.target.result; };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('form-add').onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd);
        showLoading(true);
        google.script.run.withSuccessHandler(res => {
            showLoading(false);
            if(res.success) {
                document.getElementById('modal-add-user').classList.add('hidden');
                Swal.fire('Success', 'เพิ่มข้อมูลสำเร็จ', 'success');
                // Normally we'd reload or re-fetch data here
                // google.script.run.withSuccessHandler(initSystem).getInitialData();
            } else {
                Swal.fire('Error', res.message, 'error');
            }
        }).crudManager('add', 'students', data);
    };

    function loadHistory() {
        const branch = document.getElementById('history-branch-filter').value;
        const tbody = document.getElementById('history-table-body');
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">กำลังโหลด...</td></tr>';
        
        google.script.run.withSuccessHandler(logs => {
            tbody.innerHTML = '';
            if(logs.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">ไม่พบข้อมูล</td></tr>';
            logs.forEach(log => {
                tbody.innerHTML += `
                <tr class="border-b">
                    <td class="p-3">${new Date(log.Timestamp).toLocaleString('th-TH')}</td>
                    <td class="p-3">${log.Name}</td>
                    <td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${log.Branch}</span></td>
                    <td class="p-3"><span class="${log.Status==='สาย'?'text-yellow-600':'text-green-600'}">${log.Status}</span></td>
                    <td class="p-3"><a href="${log.EvidencePhoto}" target="_blank" class="text-blue-500 underline text-xs">ดูรูป</a></td>
                </tr>`;
            });
        }).getAttendanceHistory(branch);
    }

    function sendNotify() {
        const branch = document.getElementById('notify-branch').value;
        const subject = document.getElementById('notify-subject').value;
        const detail = document.getElementById('notify-msg').value;
        if(!subject || !detail) return Swal.fire('Error', 'กรุณากรอกข้อมูลให้ครบ', 'error');

        showLoading(true, "กำลังส่งประกาศ...");
        google.script.run.withSuccessHandler(res => {
            showLoading(false);
            if(res.success) {
                Swal.fire('Success', res.message, 'success');
                document.getElementById('notify-subject').value = '';
                document.getElementById('notify-msg').value = '';
            } else {
                Swal.fire('Error', res.message, 'error');
            }
        }).sendAnnouncement({branch, subject, detail});
    }

    function deleteUser(id) {
        Swal.fire({
            title: 'ยืนยันการลบ?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ลบเลย'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading(true);
                google.script.run.withSuccessHandler((res) => {
                    showLoading(false);
                    if(res.success) Swal.fire('Deleted!', res.message, 'success');
                    else Swal.fire('Error', res.message, 'error');
                }).crudManager('delete', 'students', {id: id});
            }
        });
    }
  </script>
</body>
</html>